<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Street networks and time-based routing • dodgr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Street networks and time-based routing">
<meta property="og:description" content="dodgr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dodgr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.7.017</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ATFutures/dodgr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Street networks and time-based routing</h1>
                        <h4 class="author">Mark Padgham</h4>
            
            <h4 class="date">2020-08-28</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ATFutures/dodgr/blob/master/vignettes/times.Rmd"><code>vignettes/times.Rmd</code></a></small>
      <div class="hidden name"><code>times.Rmd</code></div>

    </div>

    
    
<div id="street-networks-and-time-based-routing" class="section level1">
<h1 class="hasAnchor">
<a href="#street-networks-and-time-based-routing" class="anchor"></a>1 Street Networks and Time-Based Routing</h1>
<p>This vignette describes the use of the <code>dodgr</code> package for routing through street networks, specifically for Open Street Map (OSM) networks extracted with the <a href="https://github.com/ropensci/osmdata"><code>osmdata</code> package</a>, or via the <code>dodgr</code> functions <a href="https://atfutures.github.io/dodgr/reference/dodgr_streetnet.html"><code><a href="../reference/dodgr_streetnet.html">dodgr_streetnet()</a></code></a> and <a href="https://atfutures.github.io/dodgr/reference/dodgr_streetnet_sc.html"><code><a href="../reference/dodgr_streetnet_sc.html">dodgr_streetnet_sc()</a></code></a>. Both of these functions use the <a href="https://github.com/ropensci/osmdata"><code>osmdata</code> package</a> package to extract networks from Open Street Map, with the former returning data in <a href="https://cran.r-project.org/package=sf">Simple Features (<code>sf</code>)</a> format, and the latter in <a href="https://github.com/hypertidy/silicate">Silicate (<code>sc</code>)</a> format. The latter format enables more detailed weighting, notably including the effects of turning angles and elevation, as described below.</p>
<p>This vignette describes different approaches to weighting street networks for routing based on either distances (shortest paths) or times (fastest paths). We start by briefly describing the <a href="https://github.com/hypertidy/silicate">Silicate (<code>sc</code>)</a> format data returned by <a href="https://atfutures.github.io/dodgr/reference/dodgr_streetnet_sc.html"><code><a href="../reference/dodgr_streetnet_sc.html">dodgr_streetnet_sc()</a></code></a>, including the ability to incorporate elevation data, before describing how to use these data for different kinds of routing.</p>
</div>
<div id="silicate-data-and-the-dodgr_streetnet_sc-function" class="section level1">
<h1 class="hasAnchor">
<a href="#silicate-data-and-the-dodgr_streetnet_sc-function" class="anchor"></a>2. Silicate data and the <code>dodgr_streetnet_sc()</code> function</h1>
<p><a href="https://github.com/hypertidy/silicate">Silicate (<code>sc</code>)</a> is a new format for spatial data. Unlike almost all previous formats available in <strong>R</strong> for representing and processing spatial data, which attempt to wrangle complex, multidimensional data into a single, flat table, the <a href="https://github.com/hypertidy/silicate">Silicate (<code>sc</code>)</a> format is multi-tabular. In its simplest form, it consists of three tables of vertices, edges, and objects. The vertices are points, the edges are binary relationships or connections between them, and the objects are high-order relationships or assemblages of edges. The new <a href="https://github.com/ropensci/osmdata"><code>osmdata</code></a> function, <a href="https://ropensci.github.io/osmdata/reference/osmdata_sc.html"><code>osmdata_sc()</code></a> extracts OSM data in <a href="https://github.com/hypertidy/silicate">Silicate (<code>sc</code>)</a> format, and returns seven tables plus an additional table of meta-data. The <code>dodgr</code> functions may be directly used without understanding the format of these data, but for those wishing to know, the tables are:</p>
<ol style="list-style-type: decimal">
<li>
<code>nodes</code>, containing all OSM key-value data for nodes or vertices;</li>
<li>
<code>relation_members</code> containing all membership information of OSM relations;</li>
<li>
<code>relation_properties</code>, containing all key-value data for OSM relations;</li>
<li>
<code>object</code>, containing all key-value data for OSM ways;</li>
<li>
<code>object_link_edge</code>, connecting all <code>object</code> members to their constituent edges;</li>
<li>
<code>edge</code>, a simple table of vertex pairs forming each edge; and</li>
<li>
<code>vertex</code>, containing the coordinates and ID values of each OSM node, along with elevation data if provided.</li>
</ol>
<p>Elevation data are used in time-based routing, and are particularly important for modelling pedestrian and bicycle transport. The may be readily incorporated with <a href="https://github.com/hypertidy/silicate">Silicate (<code>sc</code>)</a> format data with the new <a href="https://github.com/ropensci/osmdata"><code>osmdata</code></a> function, <a href="https://ropensci.github.io/osmdata/reference/osm_elevation.html"><code>osm_elevation()</code></a>. This function requires a locally-stored GeoTIFF-formatted elevation data file to be downloaded from the <a href="http://srtm.csi.cgiar.org/srtmdata/">Consortium for Spatial Information</a>, or any other source. These data may then be appended by calling <a href="https://ropensci.github.io/osmdata/reference/osm_elevation.html"><code>osm_elevation()</code></a>, and specifying the name of this file. While time-based routing is possible with <a href="https://cran.r-project.org/package=sf"><code>sf</code></a> format data, it is currently not possible to incorporate elevation data with such data.</p>
</div>
<div id="the-weight_streetnet-function" class="section level1">
<h1 class="hasAnchor">
<a href="#the-weight_streetnet-function" class="anchor"></a>3. The <code>weight_streetnet()</code> function</h1>
<p>The <code>dodgr</code> package represents all networks, including street networks, in flat, tabular form in which each row represents a network edge. Spatial data derived from OSM, either explicitly with the <a href="https://github.com/ropensci/osmdata"><code>osmdata</code> package</a>, or through the <code>dodgr</code> helper functions, <a href="https://atfutures.github.io/dodgr/reference/dodgr_streetnet.html"><code><a href="../reference/dodgr_streetnet.html">dodgr_streetnet()</a></code></a> for <a href="https://cran.r-project.org/package=sf"><code>sf</code></a> or <a href="https://atfutures.github.io/dodgr/reference/dodgr_streetnet_sc.html"><code><a href="../reference/dodgr_streetnet_sc.html">dodgr_streetnet_sc()</a></code></a> for <a href="https://github.com/hypertidy/silicate"><code>sc</code></a> format data, may be directly submitted to the <code>dodgr</code> function, <a href="https://atfutures.github.io/dodgr/reference/weight_streetnet.html"><code><a href="../reference/weight_streetnet.html">weight_streetnet()</a></code></a>. The two most important parameters in this function are:</p>
<ol style="list-style-type: decimal">
<li>
<code>wt_profile</code>, a character string generally specifying a mode of transport (generally one of “bicycle”, “foot”, “goods”, “hgv”, “horse”, “moped”, “motorcar”, “motorcycle”, “psv”, or “wheelchair”); and</li>
<li>
<code>turn_penalty</code>, specifying whether edge times should include delays associated with turning across oncoming traffic.</li>
</ol>
<p>The first of these options is described further in the following sub-section. The second option has no effect for <a href="https://cran.r-project.org/package=sf"><code>sf</code></a> data, but is particularly important for <a href="https://github.com/hypertidy/silicate"><code>sc</code></a> format data, for which it enables estimation of temporal delays associated with turning across oncoming traffic. Calculation of turn penalties is achieved through fundamentally modifying the resultant graph as depicted in Fig. 1.</p>
<p><img src="times-fig1.png"></p>
<p>Figure 1 depicts a right-angled crossing, with straight arrows showing a single directed edge into the crossing (solid black line), and three directed edges going out (solid grey lines). Turning across oncoming traffic generally takes time (the precise values for which are detailed in the following section), and so turning left (<span class="math inline">\(A\rightarrow B\)</span> in Fig. 1) is always different to turning right (<span class="math inline">\(A\rightarrow C\)</span>). To reflect these differences, graphs are weighted to account for turning penalties by adding three “compound” edges directly connecting <span class="math inline">\(A\)</span> with the end points of <span class="math inline">\(B\)</span>, <span class="math inline">\(C\)</span>, and <span class="math inline">\(D\)</span>, including the additional time penalties for turning across oncoming traffic. (The latter are naturally dependent on which side of the road traffic travels, and so <code><a href="../reference/weight_streetnet.html">weight_streetnet()</a></code> includes an additional <code>left_side</code> parameter to specify whether traffic travels on the left side of the street.)</p>
<p>The compound edges do not, however, simply replace the previous edges, because routing may still need to begin or end at the junction node, <span class="math inline">\(O\)</span>. The edge <span class="math inline">\(A\rightarrow O\)</span> is thus retained so that <span class="math inline">\(O\)</span> may be used as a destination for routing, but <span class="math inline">\(O\)</span> in this case no longer connects with the outgoing edges. Because <span class="math inline">\(O\)</span> may also be used as a starting node for routing, then the edges <span class="math inline">\(O\rightarrow B\)</span>, <span class="math inline">\(O\rightarrow C\)</span>, and <span class="math inline">\(O\rightarrow D\)</span> must also be retained. Because <code>dodgr</code> works by uniquely labelling all nodes and edges, the entire situation depicted in Fig. 1 is achieved by replacing <span class="math inline">\(O\)</span> with two new nodes labelled <span class="math inline">\(O\_start\)</span> and <span class="math inline">\(O\_end\)</span>, with the end result of replacing the former four directed edges with the following seven edges:</p>
<ol style="list-style-type: decimal">
<li>
<span class="math inline">\(A\rightarrow O\_end\)</span> (original black edge, where <span class="math inline">\(O\_end\)</span> no longer connects to any other node);</li>
<li>
<span class="math inline">\(O\_start\rightarrow B\)</span> (original grey edges, where no nodes connect to <span class="math inline">\(O\_start\)</span>);</li>
<li>
<span class="math inline">\(O\_start\rightarrow C\)</span> (…);</li>
<li>
<span class="math inline">\(O\_start\rightarrow D\)</span> (…);</li>
<li>
<span class="math inline">\(A\rightarrow B\)</span> (new compound edge);</li>
<li>
<span class="math inline">\(A\rightarrow C\)</span> (…);</li>
<li>
<span class="math inline">\(A\rightarrow D\)</span> (…);</li>
</ol>
<p>Weighting for time-based routing thus not only introduces new “compound” edges, but also requires re-labelling junction vertices, through appending either “_start” or “_end”. Recommended practice for routing in such cases is to select routing vertices (origins and destinations) from a standard weighted graph (that is, one generated with <code>turn_penalty = FALSE</code>), and then to modify these routing vertices as illustrated in the following example:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">dat_sc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dodgr_streetnet_sc.html">dodgr_streetnet_sc</a></span> (<span class="st">"ogbomosho nigeria"</span>)
<span class="no">graph</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/weight_streetnet.html">weight_streetnet</a></span> (<span class="no">dat_sc</span>, <span class="kw">wt_profile</span> <span class="kw">=</span> <span class="st">"bicycle"</span>)
<span class="no">graph_t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/weight_streetnet.html">weight_streetnet</a></span> (<span class="no">dat_sc</span>, <span class="kw">wt_profile</span> <span class="kw">=</span> <span class="st">"bicycle"</span>, <span class="kw">turn_penalty</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span> (<span class="no">graph</span>); <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span> (<span class="no">graph_t</span>)</pre></body></html></div>
<pre><code>## [1] 164168 173160</code></pre>
<p>The time-weighted graph has additional compound edges used to reflect the penalty for turning across traffic. Let’s now presume we want to calculate distances between some number of randomly-selected street junctions. The junctions may readily be extracted through the <a href="https://atfutures.github.io/dodgr/reference/dodgr_contract_graph.html"><code><a href="../reference/dodgr_contract_graph.html">dodgr_contract_graph()</a></code> function</a>, which reduces the graph to junction vertices only. The junction vertices of <code>graph_t</code> are re-labelled as described above to separate incoming from outgoing edges (through appending <code>_start</code> and <code>_end</code> to vertex names), and so may not be used for routing. Instead, routing points should be taken from the contracted version of the original graph.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">graphc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dodgr_contract_graph.html">dodgr_contract_graph</a></span> (<span class="no">graph</span>) <span class="co"># not graph_t!</span>
<span class="no">v</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dodgr_vertices.html">dodgr_vertices</a></span> (<span class="no">graphc</span>)
<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">100</span> <span class="co"># number of desired vertices</span>
<span class="no">from</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span> (<span class="no">v</span>$<span class="no">id</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="no">n</span>)
<span class="no">to</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span> (<span class="no">v</span>$<span class="no">id</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="no">n</span>)</pre></body></html></div>
<p>These can then be submitted to any <code>dodgr</code> functions along with the graph with turn penalties, and will be matched on to the corresponding nodes appended with <code>_start</code> for the <code>from</code>vertices and <code>_end</code> for the <code>to</code> vertices. As usual, it will generally be quicker to first contract the graph prior to routing.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">graph_tc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dodgr_contract_graph.html">dodgr_contract_graph</a></span> (<span class="no">graph_t</span>)
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span> (<span class="no">graph_tc</span>); <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span> (<span class="no">graph_t</span>)</pre></body></html></div>
<pre><code>## [1]  35808 176160</code></pre>
<p>Contracting this graph has reduced its size by almost 80%, translating to considerably faster routing queries. The resultant graph, along with the <code>from</code> and <code>to</code> routing points, may be passed to any of the <code>dodgr</code> routing functions, such as <a href="https://atfutures.github.io/dodgr/reference/dodgr_distances.html"><code><a href="../reference/dodgr_distances.html">dodgr_distances()</a></code></a>, <a href="https://atfutures.github.io/dodgr/reference/dodgr_paths.html"><code><a href="../reference/dodgr_paths.html">dodgr_paths()</a></code></a>, or even <a href="https://atfutures.github.io/dodgr/reference/dodgr_flows_aggregate.html"><code><a href="../reference/dodgr_flows_aggregate.html">dodgr_flows_aggregate()</a></code></a>, as well as the all-new function detailed in the following section, <a href="https://atfutures.github.io/dodgr/reference/dodgr_times.html"><code><a href="../reference/dodgr_times.html">dodgr_times()</a></code></a>.</p>
<div id="weighting-profiles-and-the-write_dodgr_wt_profile-function" class="section level2">
<h2 class="hasAnchor">
<a href="#weighting-profiles-and-the-write_dodgr_wt_profile-function" class="anchor"></a>3.1 Weighting profiles and the <code>write_dodgr_wt_profile</code> function</h2>
<p>As demonstrated above, usage of the <a href="https://atfutures.github.io/dodgr/reference/weight_streetnet.html"><code><a href="../reference/weight_streetnet.html">weight_streetnet()</a></code></a> function will generally be as simple as specifying the mode of transport for which the network is to be weighted. It may nevertheless be desirable to explicitly determine individual aspects of a weighting profile (such as the time penalties for turning angles explored above). All weighting profiles are contained in the internal data, <code><a href="../reference/weighting_profiles.html">dodgr::weighting_profiles</a></code>, which contain the following data, for brevity showing only the “bicycle” mode:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span> (<span class="kw pkg">dodgr</span><span class="kw ns">::</span><span class="no"><a href="../reference/weighting_profiles.html">weighting_profiles</a></span>, <span class="kw">function</span> (<span class="no">i</span>) <span class="no">i</span> [<span class="no">i</span>$<span class="no">name</span> <span class="kw">==</span> <span class="st">"bicycle"</span>, ])</pre></body></html></div>
<pre><code>## $weighting_profiles
##       name            way value max_speed
## 67 bicycle       motorway  0.00        NA
## 68 bicycle          trunk  0.30        NA
## 69 bicycle        primary  0.70        15
## 70 bicycle      secondary  0.80        15
## 71 bicycle       tertiary  0.90        15
## 72 bicycle   unclassified  0.90        15
## 73 bicycle    residential  0.90        15
## 74 bicycle        service  0.90        15
## 75 bicycle          track  0.90        12
## 76 bicycle       cycleway  1.00        15
## 77 bicycle           path  0.90        12
## 78 bicycle          steps  0.50         4
## 79 bicycle          ferry  0.20        15
## 80 bicycle  living_street  0.95        15
## 81 bicycle      bridleway  0.70         8
## 82 bicycle        footway  0.90         4
## 83 bicycle     pedestrian  0.80         4
## 84 bicycle  motorway_link  0.00        NA
## 85 bicycle     trunk_link  0.30        NA
## 86 bicycle   primary_link  0.70        15
## 87 bicycle secondary_link  0.80        15
## 88 bicycle  tertiary_link  0.90        15
## 
## $surface_speeds
##       name     key                 value max_speed
## 24 bicycle surface cobblestone:flattened        10
## 25 bicycle surface         paving_stones        10
## 26 bicycle surface             compacted        10
## 27 bicycle surface           cobblestone         6
## 28 bicycle surface               unpaved         6
## 29 bicycle surface           fine_gravel         6
## 30 bicycle surface                gravel         6
## 31 bicycle surface           pebblestone         6
## 32 bicycle surface                ground         6
## 33 bicycle surface                  dirt         6
## 34 bicycle surface                 earth         6
## 35 bicycle surface                 grass         6
## 36 bicycle surface                   mud         3
## 37 bicycle surface                  sand         3
## 38 bicycle surface                  sett        10
## 
## $penalties
##      name traffic_lights turn
## 4 bicycle              2    6</code></pre>
<p>The main <code>weighting_profiles$weighting_profiles</code> table contains a <code>value</code> column used to determine preferential weightings for particular kinds of ways for the designated mode of transport, from a maximum of 1.0 for the most preferable ways to 0.0 for ways that are untraversable for that mode of transport, along with an additional column specifying maximum speeds in kilometres per hour. Actual maximum speeds may be reduced by changes in surface, as specified in the second table (<code>surface_speeds</code>), while the final table contains time penalties in seconds for both traffic lights and turn penalties.</p>
<p>Values in this table may be edited by first creating a local, <code>json</code>-formatted version with the function, <a href="https://atfutures.github.io/dodgr/reference/write_dodgr_wt_profile.html"><code><a href="../reference/write_dodgr_wt_profile.html">write_dodgr_wt_profile()</a></code></a>, editing the values as desired, and then specifying the location of the <code>json</code> file containing the modified data with the additional argument to <a href="https://atfutures.github.io/dodgr/reference/weight_streetnet.html"><code><a href="../reference/weight_streetnet.html">weight_streetnet()</a></code></a> of <code>wt_profile_file</code>.</p>
</div>
</div>
<div id="time-based-routing-and-the-dodgr_times-function" class="section level1">
<h1 class="hasAnchor">
<a href="#time-based-routing-and-the-dodgr_times-function" class="anchor"></a>4. Time-based routing and the <code>dodgr_times()</code> function</h1>
<p>By default, <a href="https://atfutures.github.io/dodgr/reference/dodgr_distances.html"><code><a href="../reference/dodgr_distances.html">dodgr_distances()</a></code></a> and all other standard routing functions (<code>paths</code>, <code>flows_</code>) are <em>distance-based</em>, meaning routing is along paths with the shortest <em>distances</em>. In contrast, time-based routing calculates paths with the shortest <em>times</em>; in other words, the <em>fastest</em> rather than <em>shortest</em> paths. Distances may nevertheless be calculated along fastest paths, through the <code>shortest = FALSE</code> parameter. The function still returns distances (in metres), but as calculated along fastest paths. An example:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">graph</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/weight_streetnet.html">weight_streetnet</a></span> (<span class="no">hampi</span>, <span class="kw">wt_profile</span> <span class="kw">=</span> <span class="st">"foot"</span>)
<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">100</span> <span class="co"># number of sample routing vertices</span>
<span class="no">from</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span> (<span class="no">graph</span>$<span class="no">from_id</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="no">n</span>)
<span class="no">to</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span> (<span class="no">graph</span>$<span class="no">from_id</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="no">n</span>)
<span class="no">d_dist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dodgr_dists.html">dodgr_dists</a></span> (<span class="no">graph</span>, <span class="kw">from</span> <span class="kw">=</span> <span class="no">from</span>, <span class="kw">to</span> <span class="kw">=</span> <span class="no">to</span>, <span class="kw">shortest</span> <span class="kw">=</span> <span class="fl">TRUE</span>) <span class="co"># default</span>
<span class="no">d_time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dodgr_dists.html">dodgr_dists</a></span> (<span class="no">graph</span>, <span class="kw">from</span> <span class="kw">=</span> <span class="no">from</span>, <span class="kw">to</span> <span class="kw">=</span> <span class="no">to</span>, <span class="kw">shortest</span> <span class="kw">=</span> <span class="fl">FALSE</span>) <span class="co"># fastest paths</span>
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span> (<span class="no">d_dist</span> / <span class="fl">1000</span>, <span class="no">d_time</span> / <span class="fl">1000</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"orange"</span>,
      <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"distances along shortest paths (km)"</span>,
      <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"distances along fastest paths (km)"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span> (<span class="fl">0</span>:<span class="fl">100</span>, <span class="fl">0</span>:<span class="fl">100</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="times_files/figure-html/shortest-vs-fastest-1.png" width="700"></p>
<p>The average distance between the two (in metres) is:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span> (<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span> (<span class="no">d_time</span> - <span class="no">d_dist</span>), <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<pre><code>## [1] 46.03612</code></pre>
<p>The plot reveals that shortest distances are indeed somewhat shorter than distances along fastest paths, but also that some fastest paths are actually shorter than shortest paths:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">index</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span> (!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span> (<span class="no">d_time</span>) <span class="kw">&amp;</span> !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span> (<span class="no">d_dist</span>))
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span> (<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span> (<span class="no">d_time</span> [<span class="no">index</span>] <span class="kw">&lt;</span> <span class="no">d_dist</span> [<span class="no">index</span>])) / <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span> (<span class="no">index</span>)</pre></body></html></div>
<pre><code>## [1] 0.01489555</code></pre>
<p>While <code>dodgr</code> and indeed all routing engines attempt to maximally reconcile differences between fastest and shortest routes, there nevertheless remain important discrepancies. Foremost among these, and the primary reason why some fastest routes may in fact be shorter than shortest routes, is that fastest routes allocate preferences for different kinds of way based both on the <code>value</code> column in the <code>weighting_profiles$weighting_profiles</code> table illustrated above, and on the actual maximum speed of a given edge, which itself may be a combination of maximum speeds as specified in OSM itself, maximum speeds from the <code>weighting_profiles$weighting_profiles</code> table, or values specific to a given surface. The result is that some unique combination of maximum speeds along a network may lead to <em>fastest</em> routes being preferentially directed along a path that is actually shorter than the direct shortest path which is calculated independent of maximum speed values.</p>
<p>Such discrepancies are important in understanding differences in routes <em>times</em> calculated along shortest versus fastest paths. These times can be calculated (in seconds) with the <a href="https://atfutures.github.io/dodgr/reference/dodgr_times.html"><code><a href="../reference/dodgr_times.html">dodgr_times()</a></code></a> function:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">t_dist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dodgr_times.html">dodgr_times</a></span> (<span class="no">graph</span>, <span class="kw">from</span> <span class="kw">=</span> <span class="no">from</span>, <span class="kw">to</span> <span class="kw">=</span> <span class="no">to</span>, <span class="kw">shortest</span> <span class="kw">=</span> <span class="fl">TRUE</span>) <span class="co"># default</span>
<span class="no">t_time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dodgr_times.html">dodgr_times</a></span> (<span class="no">graph</span>, <span class="kw">from</span> <span class="kw">=</span> <span class="no">from</span>, <span class="kw">to</span> <span class="kw">=</span> <span class="no">to</span>, <span class="kw">shortest</span> <span class="kw">=</span> <span class="fl">FALSE</span>) <span class="co"># fastest paths</span>
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span> (<span class="no">t_dist</span> / <span class="fl">3600</span>, <span class="no">t_time</span> / <span class="fl">3600</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"orange"</span>,
      <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"times along shortest paths (hours)"</span>,
      <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"times along fastest paths (hours)"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span> (<span class="fl">0</span>:<span class="fl">100</span>, <span class="fl">0</span>:<span class="fl">100</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="times_files/figure-html/shortest-vs-fastest-times-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span> (<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span> (<span class="no">t_time</span> - <span class="no">t_dist</span>), <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<pre><code>## [1] 47.46474</code></pre>
<p>As above, times along fastest paths are generally less than times along shortest paths, although there are again a few exceptions:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">index</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span> (!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span> (<span class="no">t_time</span>) <span class="kw">&amp;</span> !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span> (<span class="no">t_dist</span>))
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span> (<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span> (<span class="no">t_dist</span> [<span class="no">index</span>] <span class="kw">&lt;</span> <span class="no">t_time</span> [<span class="no">index</span>])) / <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span> (<span class="no">index</span>)</pre></body></html></div>
<pre><code>## [1] 0.009809264</code></pre>
<p>These results demonstrate how the combination of the <a href="https://atfutures.github.io/dodgr/reference/dodgr_distances.html"><code><a href="../reference/dodgr_distances.html">dodgr_distances()</a></code></a> and <a href="https://atfutures.github.io/dodgr/reference/dodgr_times.html"><code><a href="../reference/dodgr_times.html">dodgr_times()</a></code></a> functions enable calculation of both distances and times along both shortest and fastest paths.</p>
<div id="time-based-paths-and-flow-aggregation" class="section level2">
<h2 class="hasAnchor">
<a href="#time-based-paths-and-flow-aggregation" class="anchor"></a>4.1 Time-based paths and flow aggregation</h2>
<p>The <a href="https://atfutures.github.io/dodgr/reference/dodgr_times.html"><code><a href="../reference/dodgr_times.html">dodgr_times()</a></code></a> works by simply swapping the columns of a graph, so that distance becomes time, and weighted distance becomes weighted time. The other <code>dodgr</code> routing functions (<a href="https://atfutures.github.io/dodgr/reference/dodgr_paths.html"><code><a href="../reference/dodgr_paths.html">dodgr_paths()</a></code></a>, <a href="https://atfutures.github.io/dodgr/reference/dodgr_flows_aggregate.html"><code><a href="../reference/dodgr_flows_aggregate.html">dodgr_flows_aggregate()</a></code></a>, <a href="https://atfutures.github.io/dodgr/reference/dodgr_flows_disperse.html"><code><a href="../reference/dodgr_flows_disperse.html">dodgr_flows_disperse()</a></code></a>) do not have explicit time-based equivalents. Instead, time-based routing can be implemented simply through replacing the weighted distance column (<code>d_weighted</code>) with the weighted time column (<code>time_weighted</code>):</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">graph</span>$<span class="no">d_weighted</span> <span class="kw">&lt;-</span> <span class="no">graph</span>$<span class="no">time_weighted</span></pre></body></html></div>
<p>All routes will then be automatically calculated along fastest rather than shortest routes.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Padgham, Andreas Petutschnig.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
